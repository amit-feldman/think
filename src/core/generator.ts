import { writeFile, readFile } from "fs/promises";
import { existsSync } from "fs";
import { CONFIG, thinkPath } from "./config";
import { parseMarkdown } from "./parser";

/**
 * Generate CLAUDE.md from ~/.think sources
 * Outputs to ~/.claude/CLAUDE.md which Claude reads automatically
 */
export async function generatePlugin(): Promise<void> {
  const sections: string[] = [];

  sections.push("# Personal Context\n");
  sections.push("This context is auto-generated by `think sync`. Edit files in ~/.think instead.\n");

  // Profile
  const profile = await parseMarkdown(thinkPath(CONFIG.files.profile));
  if (profile) {
    sections.push("## About the User\n");
    if (profile.frontmatter?.name) {
      sections.push(`Name: ${profile.frontmatter.name}\n`);
    }
    if (profile.content) {
      sections.push(profile.content);
    }
    sections.push("");
  }

  // Tool preferences
  const tools = await parseMarkdown(thinkPath(CONFIG.files.tools));
  if (tools?.content) {
    sections.push("## Tool Preferences\n");
    sections.push(tools.content);
    sections.push("");
  }

  // Patterns
  const patterns = await parseMarkdown(thinkPath(CONFIG.files.patterns));
  if (patterns?.content) {
    sections.push("## Patterns to Follow\n");
    sections.push(patterns.content);
    sections.push("");
  }

  // Anti-patterns
  const antiPatterns = await parseMarkdown(thinkPath(CONFIG.files.antiPatterns));
  if (antiPatterns?.content) {
    sections.push("## Anti-Patterns to Avoid\n");
    sections.push(antiPatterns.content);
    sections.push("");
  }

  // Learnings
  const learnings = await parseMarkdown(thinkPath(CONFIG.files.learnings));
  if (learnings?.content) {
    sections.push("## Memory - Learnings\n");
    sections.push(learnings.content);
    sections.push("");
  }

  // Corrections
  const corrections = await parseMarkdown(thinkPath(CONFIG.files.corrections));
  if (corrections?.content) {
    sections.push("## Memory - Corrections\n");
    sections.push(corrections.content);
    sections.push("");
  }

  // Subagent automation
  const subagents = await parseMarkdown(thinkPath(CONFIG.files.subagents));
  if (subagents?.content) {
    sections.push("## Automation - Subagents\n");
    sections.push("Follow these rules for automatically spawning subagents:\n");
    sections.push(subagents.content);
    sections.push("");
  }

  // Workflows
  const workflows = await parseMarkdown(thinkPath(CONFIG.files.workflows));
  if (workflows?.content) {
    sections.push("## Automation - Workflows\n");
    sections.push(workflows.content);
    sections.push("");
  }

  await writeFile(CONFIG.claudeMdPath, sections.join("\n"));
}
